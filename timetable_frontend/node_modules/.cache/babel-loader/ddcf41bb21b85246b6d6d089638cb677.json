{"ast":null,"code":"/*! rasterizeHTML.js - v1.3.0 - 2018-03-18\n* http://www.github.com/cburgmer/rasterizeHTML.js\n* Copyright (c) 2018 Christoph Burgmer; Licensed MIT */\n(function (root, factory) {\n  if (root === undefined && window !== undefined) root = window;\n\n  if (typeof define === 'function' && define.amd) {\n    // AMD. Register as an anonymous module unless amdModuleId is set\n    define([\"url\", \"xmlserializer\", \"sane-domparser-error\", \"inlineresources\"], function (a0, b1, c2, d3) {\n      return root['rasterizeHTML'] = factory(a0, b1, c2, d3);\n    });\n  } else if (typeof module === 'object' && module.exports) {\n    // Node. Does not work with strict CommonJS, but\n    // only CommonJS-like environments that support module.exports,\n    // like Node.\n    module.exports = factory(require(\"url\"), require(\"xmlserializer\"), require(\"sane-domparser-error\"), require(\"inlineresources\"));\n  } else {\n    root['rasterizeHTML'] = factory(root[\"url\"], root[\"xmlserializer\"], root[\"sanedomparsererror\"], root[\"inlineresources\"]);\n  }\n})(this, function (url, xmlserializer, sanedomparsererror, inlineresources) {\n  var util = function (url) {\n    \"use strict\";\n\n    var module = {};\n    var uniqueIdList = [];\n\n    module.joinUrl = function (baseUrl, relUrl) {\n      if (!baseUrl) {\n        return relUrl;\n      }\n\n      return url.resolve(baseUrl, relUrl);\n    };\n\n    module.getConstantUniqueIdFor = function (element) {\n      // HACK, using a list results in O(n), but how do we hash e.g. a DOM node?\n      if (uniqueIdList.indexOf(element) < 0) {\n        uniqueIdList.push(element);\n      }\n\n      return uniqueIdList.indexOf(element);\n    };\n\n    module.clone = function (object) {\n      var theClone = {},\n          i;\n\n      for (i in object) {\n        if (object.hasOwnProperty(i)) {\n          theClone[i] = object[i];\n        }\n      }\n\n      return theClone;\n    };\n\n    var isObject = function (obj) {\n      return typeof obj === \"object\" && obj !== null;\n    };\n\n    var isCanvas = function (obj) {\n      return isObject(obj) && Object.prototype.toString.apply(obj).match(/\\[object (Canvas|HTMLCanvasElement)\\]/i);\n    }; // args: canvas, options\n\n\n    module.parseOptionalParameters = function (args) {\n      var parameters = {\n        canvas: null,\n        options: {}\n      };\n\n      if (args[0] == null || isCanvas(args[0])) {\n        parameters.canvas = args[0] || null;\n        parameters.options = module.clone(args[1]);\n      } else {\n        parameters.options = module.clone(args[0]);\n      }\n\n      return parameters;\n    };\n\n    return module;\n  }(url); // Proxy objects by monkey patching\n\n\n  var proxies = function (util) {\n    \"use strict\";\n\n    var module = {};\n\n    var monkeyPatchInstanceMethod = function (object, methodName, proxyFunc) {\n      var originalFunc = object[methodName];\n\n      object[methodName] = function () {\n        var args = Array.prototype.slice.call(arguments);\n        return proxyFunc.apply(this, [args, originalFunc]);\n      };\n\n      return originalFunc;\n    }; // Bases all XHR calls on the given base URL\n\n\n    module.baseUrlRespectingXhr = function (XHRObject, baseUrl) {\n      var xhrConstructor = function () {\n        var xhr = new XHRObject();\n        monkeyPatchInstanceMethod(xhr, 'open', function (args, originalOpen) {\n          var method = args.shift(),\n              url = args.shift(),\n              joinedUrl = util.joinUrl(baseUrl, url);\n          return originalOpen.apply(this, [method, joinedUrl].concat(args));\n        });\n        return xhr;\n      };\n\n      return xhrConstructor;\n    }; // Provides a convenient way of being notified when all pending XHR calls are finished\n\n\n    module.finishNotifyingXhr = function (XHRObject) {\n      var totalXhrCount = 0,\n          doneXhrCount = 0,\n          waitingForPendingToClose = false;\n      var checkAllRequestsFinished;\n      var promise = new Promise(function (resolve) {\n        checkAllRequestsFinished = function () {\n          var pendingXhrCount = totalXhrCount - doneXhrCount;\n\n          if (pendingXhrCount <= 0 && waitingForPendingToClose) {\n            resolve({\n              totalCount: totalXhrCount\n            });\n          }\n        };\n      });\n\n      var xhrConstructor = function () {\n        var xhr = new XHRObject();\n        monkeyPatchInstanceMethod(xhr, 'send', function (_, originalSend) {\n          totalXhrCount += 1;\n          return originalSend.apply(this, arguments);\n        });\n        xhr.addEventListener('load', function () {\n          doneXhrCount += 1;\n          checkAllRequestsFinished();\n        });\n        return xhr;\n      };\n\n      xhrConstructor.waitForRequestsToFinish = function () {\n        waitingForPendingToClose = true;\n        checkAllRequestsFinished();\n        return promise;\n      };\n\n      return xhrConstructor;\n    };\n\n    return module;\n  }(util);\n\n  var documentUtil = function () {\n    \"use strict\";\n\n    var module = {};\n\n    var asArray = function (arrayLike) {\n      return Array.prototype.slice.call(arrayLike);\n    };\n\n    module.addClassName = function (element, className) {\n      element.className += ' ' + className;\n    };\n\n    module.addClassNameRecursively = function (element, className) {\n      module.addClassName(element, className);\n\n      if (element.parentNode !== element.ownerDocument) {\n        module.addClassNameRecursively(element.parentNode, className);\n      }\n    };\n\n    var changeCssRule = function (rule, newRuleText) {\n      var styleSheet = rule.parentStyleSheet,\n          ruleIdx = asArray(styleSheet.cssRules).indexOf(rule); // Exchange rule with the new text\n\n      styleSheet.insertRule(newRuleText, ruleIdx + 1);\n      styleSheet.deleteRule(ruleIdx);\n    };\n\n    var updateRuleSelector = function (rule, updatedSelector) {\n      var styleDefinitions = rule.cssText.replace(/^[^\\{]+/, ''),\n          newRule = updatedSelector + ' ' + styleDefinitions;\n      changeCssRule(rule, newRule);\n    };\n\n    var cssRulesToText = function (cssRules) {\n      return asArray(cssRules).reduce(function (cssText, rule) {\n        return cssText + rule.cssText;\n      }, '');\n    };\n\n    var rewriteStyleContent = function (styleElement) {\n      styleElement.textContent = cssRulesToText(styleElement.sheet.cssRules);\n    };\n\n    var addSheetPropertyToSvgStyleElement = function (svgStyleElement) {\n      var doc = document.implementation.createHTMLDocument(''),\n          cssStyleElement = document.createElement('style');\n      cssStyleElement.textContent = svgStyleElement.textContent; // the style will only be parsed once it is added to a document\n\n      doc.body.appendChild(cssStyleElement);\n      svgStyleElement.sheet = cssStyleElement.sheet;\n    };\n\n    var matchingSimpleSelectorsRegex = function (simpleSelectorList) {\n      return '(' + '(?:^|[^.#:\\\\w])' + // start of string or not a simple selector character,\n      '|' + // ... or ...\n      '(?=\\\\W)' + // the next character parsed is not an alphabetic character (and thus a natural boundary)\n      ')' + '(' + simpleSelectorList.join('|') + // one out of the given simple selectors\n      ')' + '(?=\\\\W|$)'; // followed either by a non-alphabetic character or the end of the string\n    };\n\n    var replaceSimpleSelectorsBy = function (element, simpleSelectorList, caseInsensitiveReplaceFunc) {\n      var selectorRegex = matchingSimpleSelectorsRegex(simpleSelectorList);\n      asArray(element.querySelectorAll('style')).forEach(function (styleElement) {\n        // SVGStyleElement doesn't have a property sheet in Safari, we need some workaround here\n        // more details can be found here: https://github.com/cburgmer/rasterizeHTML.js/issues/158\n        if (typeof styleElement.sheet === 'undefined') {\n          addSheetPropertyToSvgStyleElement(styleElement);\n        }\n\n        var matchingRules = asArray(styleElement.sheet.cssRules).filter(function (rule) {\n          return rule.selectorText && new RegExp(selectorRegex, 'i').test(rule.selectorText);\n        });\n\n        if (matchingRules.length) {\n          matchingRules.forEach(function (rule) {\n            var newSelector = rule.selectorText.replace(new RegExp(selectorRegex, 'gi'), function (_, prefixMatch, selectorMatch) {\n              return prefixMatch + caseInsensitiveReplaceFunc(selectorMatch);\n            });\n\n            if (newSelector !== rule.selectorText) {\n              updateRuleSelector(rule, newSelector);\n            }\n          });\n          rewriteStyleContent(styleElement);\n        }\n      });\n    };\n\n    module.rewriteCssSelectorWith = function (element, oldSelector, newSelector) {\n      replaceSimpleSelectorsBy(element, [oldSelector], function () {\n        return newSelector;\n      });\n    };\n\n    module.lowercaseCssTypeSelectors = function (element, matchingTagNames) {\n      replaceSimpleSelectorsBy(element, matchingTagNames, function (match) {\n        return match.toLowerCase();\n      });\n    };\n\n    module.findHtmlOnlyNodeNames = function (element) {\n      var treeWalker = element.ownerDocument.createTreeWalker(element, NodeFilter.SHOW_ELEMENT),\n          htmlNodeNames = {},\n          nonHtmlNodeNames = {},\n          currentTagName;\n\n      do {\n        currentTagName = treeWalker.currentNode.tagName.toLowerCase();\n\n        if (treeWalker.currentNode.namespaceURI === 'http://www.w3.org/1999/xhtml') {\n          htmlNodeNames[currentTagName] = true;\n        } else {\n          nonHtmlNodeNames[currentTagName] = true;\n        }\n      } while (treeWalker.nextNode());\n\n      return Object.keys(htmlNodeNames).filter(function (tagName) {\n        return !nonHtmlNodeNames[tagName];\n      });\n    };\n\n    return module;\n  }();\n\n  var documentHelper = function (documentUtil) {\n    \"use strict\";\n\n    var module = {};\n\n    var asArray = function (arrayLike) {\n      return Array.prototype.slice.call(arrayLike);\n    };\n\n    var cascadingAction = {\n      active: true,\n      hover: true,\n      focus: false,\n      target: false\n    };\n\n    module.fakeUserAction = function (element, selector, action) {\n      var elem = element.querySelector(selector),\n          pseudoClass = ':' + action,\n          fakeActionClass = 'rasterizehtml' + action;\n\n      if (!elem) {\n        return;\n      }\n\n      if (cascadingAction[action]) {\n        documentUtil.addClassNameRecursively(elem, fakeActionClass);\n      } else {\n        documentUtil.addClassName(elem, fakeActionClass);\n      }\n\n      documentUtil.rewriteCssSelectorWith(element, pseudoClass, '.' + fakeActionClass);\n    };\n\n    module.persistInputValues = function (doc) {\n      var inputs = doc.querySelectorAll('input'),\n          textareas = doc.querySelectorAll('textarea'),\n          isCheckable = function (input) {\n        return input.type === 'checkbox' || input.type === 'radio';\n      };\n\n      asArray(inputs).filter(isCheckable).forEach(function (input) {\n        if (input.checked) {\n          input.setAttribute('checked', '');\n        } else {\n          input.removeAttribute('checked');\n        }\n      });\n      asArray(inputs).filter(function (input) {\n        return !isCheckable(input);\n      }).forEach(function (input) {\n        input.setAttribute('value', input.value);\n      });\n      asArray(textareas).forEach(function (textarea) {\n        textarea.textContent = textarea.value;\n      });\n    };\n\n    module.rewriteTagNameSelectorsToLowerCase = function (element) {\n      documentUtil.lowercaseCssTypeSelectors(element, documentUtil.findHtmlOnlyNodeNames(element));\n    };\n\n    return module;\n  }(documentUtil);\n\n  var browser = function (util, proxies, sanedomparsererror, theWindow) {\n    \"use strict\";\n\n    var module = {};\n\n    var createHiddenElement = function (doc, tagName, width, height) {\n      var element = doc.createElement(tagName); // 'display: none' doesn't cut it, as browsers seem to be lazy loading CSS\n\n      element.style.visibility = \"hidden\";\n      element.style.width = width + \"px\";\n      element.style.height = height + \"px\";\n      element.style.position = \"absolute\";\n      element.style.top = -10000 - height + \"px\";\n      element.style.left = -10000 - width + \"px\"; // We need to add the element to the document so that its content gets loaded\n\n      doc.getElementsByTagName(\"body\")[0].appendChild(element);\n      return element;\n    };\n\n    var wait = function (timeout) {\n      if (timeout > 0) {\n        return new Promise(function (resolve) {\n          setTimeout(resolve, timeout);\n        });\n      } else {\n        return Promise.resolve();\n      }\n    };\n\n    module.executeJavascript = function (element, options) {\n      return new Promise(function (resolve) {\n        var iframe = createHiddenElement(theWindow.document, \"iframe\", options.width, options.height),\n            html = element.outerHTML,\n            iframeErrorsMessages = [],\n            executeJsTimeout = options.executeJsTimeout || 0;\n\n        var doResolve = function () {\n          var doc = iframe.contentDocument;\n          theWindow.document.getElementsByTagName(\"body\")[0].removeChild(iframe);\n          resolve({\n            document: doc,\n            errors: iframeErrorsMessages\n          });\n        };\n\n        var xhr = iframe.contentWindow.XMLHttpRequest,\n            finishNotifyXhrProxy = proxies.finishNotifyingXhr(xhr),\n            baseUrlXhrProxy = proxies.baseUrlRespectingXhr(finishNotifyXhrProxy, options.baseUrl);\n\n        iframe.onload = function () {\n          wait(executeJsTimeout).then(finishNotifyXhrProxy.waitForRequestsToFinish).then(doResolve);\n        };\n\n        iframe.contentDocument.open();\n        iframe.contentWindow.XMLHttpRequest = baseUrlXhrProxy;\n\n        iframe.contentWindow.onerror = function (msg) {\n          iframeErrorsMessages.push({\n            resourceType: \"scriptExecution\",\n            msg: msg\n          });\n        };\n\n        iframe.contentDocument.write('<!DOCTYPE html>');\n        iframe.contentDocument.write(html);\n        iframe.contentDocument.close();\n      });\n    };\n\n    var createHiddenSandboxedIFrame = function (doc, width, height) {\n      var iframe = doc.createElement('iframe');\n      iframe.style.width = width + \"px\";\n      iframe.style.height = height + \"px\"; // 'display: none' doesn't cut it, as browsers seem to be lazy loading content\n\n      iframe.style.visibility = \"hidden\";\n      iframe.style.position = \"absolute\";\n      iframe.style.top = -10000 - height + \"px\";\n      iframe.style.left = -10000 - width + \"px\"; // make sure content gets exact width independent of box-sizing value\n\n      iframe.style.borderWidth = 0; // Don't execute JS, all we need from sandboxing is access to the iframe's document\n\n      iframe.sandbox = 'allow-same-origin'; // Don't include a scrollbar on Linux\n\n      iframe.scrolling = 'no';\n      return iframe;\n    };\n\n    var createIframeWithSizeAtZoomLevel1 = function (width, height, zoom) {\n      var scaledViewportWidth = Math.floor(width / zoom),\n          scaledViewportHeight = Math.floor(height / zoom);\n      return createHiddenSandboxedIFrame(theWindow.document, scaledViewportWidth, scaledViewportHeight);\n    };\n\n    var calculateZoomedContentSizeAndRoundUp = function (actualViewport, requestedWidth, requestedHeight, zoom) {\n      return {\n        width: Math.max(actualViewport.width * zoom, requestedWidth),\n        height: Math.max(actualViewport.height * zoom, requestedHeight)\n      };\n    };\n\n    var selectElementOrDescendant = function (element, selector) {\n      var descendant = element.querySelector(selector);\n\n      if (descendant) {\n        return descendant;\n      } else if (element.ownerDocument.querySelector(selector) === element) {\n        return element;\n      }\n\n      throw {\n        message: \"Clipping selector not found\"\n      };\n    };\n\n    var calculateContentSize = function (rootElement, selector, requestedWidth, requestedHeight, zoom) {\n      // clientWidth/clientHeight needed for PhantomJS\n      var actualViewportWidth = Math.max(rootElement.scrollWidth, rootElement.clientWidth),\n          actualViewportHeight = Math.max(rootElement.scrollHeight, rootElement.clientHeight),\n          top,\n          left,\n          originalWidth,\n          originalHeight,\n          rootFontSize,\n          element,\n          rect,\n          contentSize;\n\n      if (selector) {\n        element = selectElementOrDescendant(rootElement, selector);\n        rect = element.getBoundingClientRect();\n        top = rect.top;\n        left = rect.left;\n        originalWidth = rect.width;\n        originalHeight = rect.height;\n      } else {\n        top = 0;\n        left = 0;\n        originalWidth = actualViewportWidth;\n        originalHeight = actualViewportHeight;\n      }\n\n      contentSize = calculateZoomedContentSizeAndRoundUp({\n        width: originalWidth,\n        height: originalHeight\n      }, requestedWidth, requestedHeight, zoom);\n      rootFontSize = theWindow.getComputedStyle(rootElement.ownerDocument.documentElement).fontSize;\n      return {\n        left: left,\n        top: top,\n        width: contentSize.width,\n        height: contentSize.height,\n        viewportWidth: actualViewportWidth,\n        viewportHeight: actualViewportHeight,\n        rootFontSize: rootFontSize\n      };\n    };\n\n    var findCorrelatingElement = function (element, documentClone) {\n      var tagName = element.tagName; // Stupid but simple method: find first match. Should work for a single HTML element, and any other element given as root\n\n      return documentClone.querySelector(tagName);\n    };\n\n    var elementToFullHtmlDocument = function (element) {\n      var tagName = element.tagName.toLowerCase();\n\n      if (tagName === 'html' || tagName === 'body') {\n        return element.outerHTML;\n      } // Simple hack: hide the body from sizing, otherwise browser would apply a 8px margin\n\n\n      return '<body style=\"margin: 0;\">' + element.outerHTML + '</body>';\n    };\n\n    module.calculateDocumentContentSize = function (element, options) {\n      return new Promise(function (resolve, reject) {\n        var zoom = options.zoom || 1,\n            iframe;\n        iframe = createIframeWithSizeAtZoomLevel1(options.width, options.height, zoom); // We need to add the element to the document so that its content gets loaded\n\n        theWindow.document.getElementsByTagName(\"body\")[0].appendChild(iframe);\n\n        iframe.onload = function () {\n          var doc = iframe.contentDocument,\n              size;\n\n          try {\n            size = calculateContentSize(findCorrelatingElement(element, doc), options.clip, options.width, options.height, zoom);\n            resolve(size);\n          } catch (e) {\n            reject(e);\n          } finally {\n            theWindow.document.getElementsByTagName(\"body\")[0].removeChild(iframe);\n          }\n        }; // srcdoc doesn't work in PhantomJS yet\n\n\n        iframe.contentDocument.open();\n        iframe.contentDocument.write('<!DOCTYPE html>');\n        iframe.contentDocument.write(elementToFullHtmlDocument(element));\n        iframe.contentDocument.close();\n      });\n    };\n\n    module.parseHtmlFragment = function (htmlFragment) {\n      var doc = theWindow.document.implementation.createHTMLDocument('');\n      doc.documentElement.innerHTML = htmlFragment;\n      var element = doc.querySelector('body').firstChild;\n\n      if (!element) {\n        throw \"Invalid source\";\n      }\n\n      return element;\n    };\n\n    var addHTMLTagAttributes = function (doc, html) {\n      var attributeMatch = /<html((?:\\s+[^>]*)?)>/im.exec(html),\n          helperDoc = theWindow.document.implementation.createHTMLDocument(''),\n          htmlTagSubstitute,\n          i,\n          elementSubstitute,\n          attribute;\n\n      if (!attributeMatch) {\n        return;\n      }\n\n      htmlTagSubstitute = '<div' + attributeMatch[1] + '></div>';\n      helperDoc.documentElement.innerHTML = htmlTagSubstitute;\n      elementSubstitute = helperDoc.querySelector('div');\n\n      for (i = 0; i < elementSubstitute.attributes.length; i++) {\n        attribute = elementSubstitute.attributes[i];\n        doc.documentElement.setAttribute(attribute.name, attribute.value);\n      }\n    };\n\n    module.parseHTML = function (html) {\n      // We should be using the DOMParser, but it is not supported in older browsers\n      var doc = theWindow.document.implementation.createHTMLDocument('');\n      doc.documentElement.innerHTML = html;\n      addHTMLTagAttributes(doc, html);\n      return doc;\n    };\n\n    var failOnInvalidSource = function (doc) {\n      try {\n        return sanedomparsererror.failOnParseError(doc);\n      } catch (e) {\n        throw {\n          message: \"Invalid source\",\n          originalError: e\n        };\n      }\n    };\n\n    module.validateXHTML = function (xhtml) {\n      var p = new DOMParser(),\n          doc = p.parseFromString(xhtml, \"application/xml\");\n      failOnInvalidSource(doc);\n    };\n\n    var lastCacheDate = null;\n\n    var getUncachableURL = function (url, cache) {\n      if (cache === 'none' || cache === 'repeated') {\n        if (lastCacheDate === null || cache !== 'repeated') {\n          lastCacheDate = Date.now();\n        }\n\n        return url + \"?_=\" + lastCacheDate;\n      } else {\n        return url;\n      }\n    };\n\n    var doDocumentLoad = function (url, options) {\n      return new Promise(function (resolve, reject) {\n        var xhr = new window.XMLHttpRequest(),\n            joinedUrl = util.joinUrl(options.baseUrl, url),\n            augmentedUrl = getUncachableURL(joinedUrl, options.cache),\n            doReject = function (e) {\n          reject({\n            message: \"Unable to load page\",\n            originalError: e\n          });\n        };\n\n        xhr.addEventListener(\"load\", function () {\n          if (xhr.status === 200 || xhr.status === 0) {\n            resolve(xhr.responseXML);\n          } else {\n            doReject(xhr.statusText);\n          }\n        }, false);\n        xhr.addEventListener(\"error\", function (e) {\n          doReject(e);\n        }, false);\n\n        try {\n          xhr.open('GET', augmentedUrl, true);\n          xhr.responseType = \"document\";\n          xhr.send(null);\n        } catch (e) {\n          doReject(e);\n        }\n      });\n    };\n\n    module.loadDocument = function (url, options) {\n      return doDocumentLoad(url, options).then(function (doc) {\n        return failOnInvalidSource(doc);\n      });\n    };\n\n    return module;\n  }(util, proxies, sanedomparsererror, window);\n\n  var svg2image = function (window) {\n    \"use strict\";\n\n    var module = {};\n\n    var urlForSvg = function (svg, useBlobs) {\n      if (useBlobs) {\n        return URL.createObjectURL(new Blob([svg], {\n          \"type\": \"image/svg+xml\"\n        }));\n      } else {\n        return \"data:image/svg+xml;charset=utf-8,\" + encodeURIComponent(svg);\n      }\n    };\n\n    var cleanUpUrl = function (url) {\n      if (url instanceof Blob) {\n        URL.revokeObjectURL(url);\n      }\n    };\n\n    var simpleForeignObjectSvg = '<svg xmlns=\"http://www.w3.org/2000/svg\" width=\"1\" height=\"1\"><foreignObject></foreignObject></svg>';\n\n    var supportsReadingObjectFromCanvas = function (url) {\n      return new Promise(function (resolve, reject) {\n        var canvas = document.createElement(\"canvas\"),\n            image = new Image();\n\n        image.onload = function () {\n          var context = canvas.getContext(\"2d\");\n\n          try {\n            context.drawImage(image, 0, 0); // This will fail in Chrome & Safari\n\n            canvas.toDataURL(\"image/png\");\n            resolve(true);\n          } catch (e) {\n            resolve(false);\n          }\n        };\n\n        image.onerror = reject;\n        image.src = url;\n      });\n    };\n\n    var readingBackFromCanvasBenefitsFromOldSchoolDataUris = function () {\n      // Check for work around for https://code.google.com/p/chromium/issues/detail?id=294129\n      var blobUrl = urlForSvg(simpleForeignObjectSvg, true);\n      return supportsReadingObjectFromCanvas(blobUrl).then(function (supportsReadingFromBlobs) {\n        cleanUpUrl(blobUrl);\n\n        if (supportsReadingFromBlobs) {\n          return false;\n        }\n\n        return supportsReadingObjectFromCanvas(urlForSvg(simpleForeignObjectSvg, false)).then(function (s) {\n          return s;\n        });\n      }, function () {\n        return false;\n      });\n    };\n\n    var supportsBlobBuilding = function () {\n      if (window.Blob) {\n        // Available as constructor only in newer builds for all browsers\n        try {\n          new Blob(['<b></b>'], {\n            \"type\": \"text/xml\"\n          });\n          return true;\n        } catch (err) {}\n      }\n\n      return false;\n    };\n\n    var checkBlobSupport = function () {\n      return new Promise(function (resolve, reject) {\n        if (supportsBlobBuilding() && window.URL) {\n          readingBackFromCanvasBenefitsFromOldSchoolDataUris().then(function (doesBenefit) {\n            resolve(!doesBenefit);\n          }, function () {\n            reject();\n          });\n        } else {\n          resolve(false);\n        }\n      });\n    };\n\n    var checkForBlobsResult;\n\n    var checkForBlobs = function () {\n      if (checkForBlobsResult === undefined) {\n        checkForBlobsResult = checkBlobSupport();\n      }\n\n      return checkForBlobsResult;\n    };\n\n    var buildImageUrl = function (svg) {\n      return checkForBlobs().then(function (useBlobs) {\n        return urlForSvg(svg, useBlobs);\n      });\n    };\n\n    module.renderSvg = function (svg) {\n      return new Promise(function (resolve, reject) {\n        var url,\n            image,\n            resetEventHandlers = function () {\n          image.onload = null;\n          image.onerror = null;\n        },\n            cleanUp = function () {\n          if (url) {\n            cleanUpUrl(url);\n          }\n        };\n\n        image = new Image();\n\n        image.onload = function () {\n          resetEventHandlers();\n          cleanUp();\n          resolve(image);\n        };\n\n        image.onerror = function () {\n          cleanUp(); // Webkit calls the onerror handler if the SVG is faulty\n\n          reject();\n        };\n\n        buildImageUrl(svg).then(function (imageUrl) {\n          url = imageUrl;\n          image.src = url;\n        }, reject);\n      });\n    };\n\n    return module;\n  }(window);\n\n  var document2svg = function (util, browser, documentHelper, xmlserializer) {\n    \"use strict\";\n\n    var module = {};\n\n    var svgAttributes = function (size, zoom) {\n      var zoomFactor = zoom || 1;\n      var attributes = {\n        width: size.width,\n        height: size.height,\n        'font-size': size.rootFontSize\n      };\n\n      if (zoomFactor !== 1) {\n        attributes.style = 'transform:scale(' + zoomFactor + '); transform-origin: 0 0;';\n      }\n\n      return attributes;\n    };\n\n    var foreignObjectAttributes = function (size) {\n      var closestScaledWith, closestScaledHeight, offsetX, offsetY;\n      closestScaledWith = Math.round(size.viewportWidth);\n      closestScaledHeight = Math.round(size.viewportHeight);\n      offsetX = -size.left;\n      offsetY = -size.top;\n      var attributes = {\n        'x': offsetX,\n        'y': offsetY,\n        'width': closestScaledWith,\n        'height': closestScaledHeight\n      };\n      return attributes;\n    };\n\n    var workAroundCollapsingMarginsAcrossSVGElementInWebKitLike = function (attributes) {\n      var style = attributes.style || '';\n      attributes.style = style + 'float: left;';\n    };\n\n    var workAroundSafariSometimesNotShowingExternalResources = function (attributes) {\n      /* Let's hope that works some magic. The spec says SVGLoad only fires\n       * now when all externals are available.\n       * http://www.w3.org/TR/SVG/struct.html#ExternalResourcesRequired */\n      attributes.externalResourcesRequired = true;\n    };\n\n    var workAroundChromeShowingScrollbarsUnderLinuxIfHtmlIsOverflowScroll = function () {\n      return '<style scoped=\"\">html::-webkit-scrollbar { display: none; }</style>';\n    };\n\n    var serializeAttributes = function (attributes) {\n      var keys = Object.keys(attributes);\n\n      if (!keys.length) {\n        return '';\n      }\n\n      return ' ' + keys.map(function (key) {\n        return key + '=\"' + attributes[key] + '\"';\n      }).join(' ');\n    };\n\n    var convertElementToSvg = function (element, size, zoomFactor) {\n      var xhtml = xmlserializer.serializeToString(element);\n      browser.validateXHTML(xhtml);\n      var foreignObjectAttrs = foreignObjectAttributes(size);\n      workAroundCollapsingMarginsAcrossSVGElementInWebKitLike(foreignObjectAttrs);\n      workAroundSafariSometimesNotShowingExternalResources(foreignObjectAttrs);\n      return '<svg xmlns=\"http://www.w3.org/2000/svg\"' + serializeAttributes(svgAttributes(size, zoomFactor)) + '>' + workAroundChromeShowingScrollbarsUnderLinuxIfHtmlIsOverflowScroll() + '<foreignObject' + serializeAttributes(foreignObjectAttrs) + '>' + xhtml + '</foreignObject>' + '</svg>';\n    };\n\n    module.getSvgForDocument = function (element, size, zoomFactor) {\n      documentHelper.rewriteTagNameSelectorsToLowerCase(element);\n      return convertElementToSvg(element, size, zoomFactor);\n    };\n\n    module.drawDocumentAsSvg = function (element, options) {\n      ['hover', 'active', 'focus', 'target'].forEach(function (action) {\n        if (options[action]) {\n          documentHelper.fakeUserAction(element, options[action], action);\n        }\n      });\n      return browser.calculateDocumentContentSize(element, options).then(function (size) {\n        return module.getSvgForDocument(element, size, options.zoom);\n      });\n    };\n\n    return module;\n  }(util, browser, documentHelper, xmlserializer);\n\n  var rasterize = function (util, browser, documentHelper, document2svg, svg2image, inlineresources) {\n    \"use strict\";\n\n    var module = {};\n\n    var generalDrawError = function (e) {\n      return {\n        message: \"Error rendering page\",\n        originalError: e\n      };\n    };\n\n    var drawSvgAsImg = function (svg) {\n      return svg2image.renderSvg(svg).then(function (image) {\n        return {\n          image: image,\n          svg: svg\n        };\n      }, function (e) {\n        throw generalDrawError(e);\n      });\n    };\n\n    var drawImageOnCanvas = function (image, canvas) {\n      try {\n        canvas.getContext(\"2d\").drawImage(image, 0, 0);\n      } catch (e) {\n        // Firefox throws a 'NS_ERROR_NOT_AVAILABLE' if the SVG is faulty\n        throw generalDrawError(e);\n      }\n    };\n\n    var doDraw = function (element, canvas, options) {\n      return document2svg.drawDocumentAsSvg(element, options).then(drawSvgAsImg).then(function (result) {\n        if (canvas) {\n          drawImageOnCanvas(result.image, canvas);\n        }\n\n        return result;\n      });\n    };\n\n    var operateJavaScriptOnDocument = function (element, options) {\n      return browser.executeJavascript(element, options).then(function (result) {\n        var document = result.document;\n        documentHelper.persistInputValues(document);\n        return {\n          document: document,\n          errors: result.errors\n        };\n      });\n    };\n\n    module.rasterize = function (element, canvas, options) {\n      var inlineOptions;\n      inlineOptions = util.clone(options);\n      inlineOptions.inlineScripts = options.executeJs === true;\n      return inlineresources.inlineReferences(element, inlineOptions).then(function (errors) {\n        if (options.executeJs) {\n          return operateJavaScriptOnDocument(element, options).then(function (result) {\n            return {\n              element: result.document.documentElement,\n              errors: errors.concat(result.errors)\n            };\n          });\n        } else {\n          return {\n            element: element,\n            errors: errors\n          };\n        }\n      }).then(function (result) {\n        return doDraw(result.element, canvas, options).then(function (drawResult) {\n          return {\n            image: drawResult.image,\n            svg: drawResult.svg,\n            errors: result.errors\n          };\n        });\n      });\n    };\n\n    return module;\n  }(util, browser, documentHelper, document2svg, svg2image, inlineresources);\n\n  var rasterizeHTML = function (util, browser, rasterize) {\n    \"use strict\";\n\n    var module = {};\n\n    var getViewportSize = function (canvas, options) {\n      var defaultWidth = 300,\n          defaultHeight = 200,\n          fallbackWidth = canvas ? canvas.width : defaultWidth,\n          fallbackHeight = canvas ? canvas.height : defaultHeight,\n          width = options.width !== undefined ? options.width : fallbackWidth,\n          height = options.height !== undefined ? options.height : fallbackHeight;\n      return {\n        width: width,\n        height: height\n      };\n    };\n\n    var constructOptions = function (params) {\n      var viewport = getViewportSize(params.canvas, params.options),\n          options;\n      options = util.clone(params.options);\n      options.width = viewport.width;\n      options.height = viewport.height;\n      return options;\n    };\n    /**\n     * Draws a Document to the canvas.\n     * rasterizeHTML.drawDocument( document [, canvas] [, options] ).then(function (result) { ... });\n     */\n\n\n    module.drawDocument = function () {\n      var doc = arguments[0],\n          optionalArguments = Array.prototype.slice.call(arguments, 1),\n          params = util.parseOptionalParameters(optionalArguments);\n      var element = doc.documentElement ? doc.documentElement : doc;\n      return rasterize.rasterize(element, params.canvas, constructOptions(params));\n    };\n\n    var drawHTML = function (html, canvas, options) {\n      var doc = browser.parseHTML(html);\n      return module.drawDocument(doc, canvas, options);\n    };\n    /**\n     * Draws a HTML string to the canvas.\n     * rasterizeHTML.drawHTML( html [, canvas] [, options] ).then(function (result) { ... });\n     */\n\n\n    module.drawHTML = function () {\n      var html = arguments[0],\n          optionalArguments = Array.prototype.slice.call(arguments, 1),\n          params = util.parseOptionalParameters(optionalArguments);\n      return drawHTML(html, params.canvas, params.options);\n    }; // work around https://bugzilla.mozilla.org/show_bug.cgi?id=925493\n\n\n    var workAroundFirefoxNotLoadingStylesheetStyles = function (doc, url, options) {\n      var d = document.implementation.createHTMLDocument('');\n      d.replaceChild(doc.documentElement, d.documentElement);\n      var extendedOptions = options ? util.clone(options) : {};\n\n      if (!options.baseUrl) {\n        extendedOptions.baseUrl = url;\n      }\n\n      return {\n        document: d,\n        options: extendedOptions\n      };\n    };\n\n    var drawURL = function (url, canvas, options) {\n      return browser.loadDocument(url, options).then(function (doc) {\n        var workaround = workAroundFirefoxNotLoadingStylesheetStyles(doc, url, options);\n        return module.drawDocument(workaround.document, canvas, workaround.options);\n      });\n    };\n    /**\n     * Draws a page to the canvas.\n     * rasterizeHTML.drawURL( url [, canvas] [, options] ).then(function (result) { ... });\n     */\n\n\n    module.drawURL = function () {\n      var url = arguments[0],\n          optionalArguments = Array.prototype.slice.call(arguments, 1),\n          params = util.parseOptionalParameters(optionalArguments);\n      return drawURL(url, params.canvas, params.options);\n    };\n\n    return module;\n  }(util, browser, rasterize);\n\n  return rasterizeHTML;\n});","map":{"version":3,"sources":["D:/act-back original/timetable_frontend/node_modules/rasterizehtml/dist/rasterizeHTML.js"],"names":["root","factory","undefined","window","define","amd","a0","b1","c2","d3","module","exports","require","url","xmlserializer","sanedomparsererror","inlineresources","util","uniqueIdList","joinUrl","baseUrl","relUrl","resolve","getConstantUniqueIdFor","element","indexOf","push","clone","object","theClone","i","hasOwnProperty","isObject","obj","isCanvas","Object","prototype","toString","apply","match","parseOptionalParameters","args","parameters","canvas","options","proxies","monkeyPatchInstanceMethod","methodName","proxyFunc","originalFunc","Array","slice","call","arguments","baseUrlRespectingXhr","XHRObject","xhrConstructor","xhr","originalOpen","method","shift","joinedUrl","concat","finishNotifyingXhr","totalXhrCount","doneXhrCount","waitingForPendingToClose","checkAllRequestsFinished","promise","Promise","pendingXhrCount","totalCount","_","originalSend","addEventListener","waitForRequestsToFinish","documentUtil","asArray","arrayLike","addClassName","className","addClassNameRecursively","parentNode","ownerDocument","changeCssRule","rule","newRuleText","styleSheet","parentStyleSheet","ruleIdx","cssRules","insertRule","deleteRule","updateRuleSelector","updatedSelector","styleDefinitions","cssText","replace","newRule","cssRulesToText","reduce","rewriteStyleContent","styleElement","textContent","sheet","addSheetPropertyToSvgStyleElement","svgStyleElement","doc","document","implementation","createHTMLDocument","cssStyleElement","createElement","body","appendChild","matchingSimpleSelectorsRegex","simpleSelectorList","join","replaceSimpleSelectorsBy","caseInsensitiveReplaceFunc","selectorRegex","querySelectorAll","forEach","matchingRules","filter","selectorText","RegExp","test","length","newSelector","prefixMatch","selectorMatch","rewriteCssSelectorWith","oldSelector","lowercaseCssTypeSelectors","matchingTagNames","toLowerCase","findHtmlOnlyNodeNames","treeWalker","createTreeWalker","NodeFilter","SHOW_ELEMENT","htmlNodeNames","nonHtmlNodeNames","currentTagName","currentNode","tagName","namespaceURI","nextNode","keys","documentHelper","cascadingAction","active","hover","focus","target","fakeUserAction","selector","action","elem","querySelector","pseudoClass","fakeActionClass","persistInputValues","inputs","textareas","isCheckable","input","type","checked","setAttribute","removeAttribute","value","textarea","rewriteTagNameSelectorsToLowerCase","browser","theWindow","createHiddenElement","width","height","style","visibility","position","top","left","getElementsByTagName","wait","timeout","setTimeout","executeJavascript","iframe","html","outerHTML","iframeErrorsMessages","executeJsTimeout","doResolve","contentDocument","removeChild","errors","contentWindow","XMLHttpRequest","finishNotifyXhrProxy","baseUrlXhrProxy","onload","then","open","onerror","msg","resourceType","write","close","createHiddenSandboxedIFrame","borderWidth","sandbox","scrolling","createIframeWithSizeAtZoomLevel1","zoom","scaledViewportWidth","Math","floor","scaledViewportHeight","calculateZoomedContentSizeAndRoundUp","actualViewport","requestedWidth","requestedHeight","max","selectElementOrDescendant","descendant","message","calculateContentSize","rootElement","actualViewportWidth","scrollWidth","clientWidth","actualViewportHeight","scrollHeight","clientHeight","originalWidth","originalHeight","rootFontSize","rect","contentSize","getBoundingClientRect","getComputedStyle","documentElement","fontSize","viewportWidth","viewportHeight","findCorrelatingElement","documentClone","elementToFullHtmlDocument","calculateDocumentContentSize","reject","size","clip","e","parseHtmlFragment","htmlFragment","innerHTML","firstChild","addHTMLTagAttributes","attributeMatch","exec","helperDoc","htmlTagSubstitute","elementSubstitute","attribute","attributes","name","parseHTML","failOnInvalidSource","failOnParseError","originalError","validateXHTML","xhtml","p","DOMParser","parseFromString","lastCacheDate","getUncachableURL","cache","Date","now","doDocumentLoad","augmentedUrl","doReject","status","responseXML","statusText","responseType","send","loadDocument","svg2image","urlForSvg","svg","useBlobs","URL","createObjectURL","Blob","encodeURIComponent","cleanUpUrl","revokeObjectURL","simpleForeignObjectSvg","supportsReadingObjectFromCanvas","image","Image","context","getContext","drawImage","toDataURL","src","readingBackFromCanvasBenefitsFromOldSchoolDataUris","blobUrl","supportsReadingFromBlobs","s","supportsBlobBuilding","err","checkBlobSupport","doesBenefit","checkForBlobsResult","checkForBlobs","buildImageUrl","renderSvg","resetEventHandlers","cleanUp","imageUrl","document2svg","svgAttributes","zoomFactor","foreignObjectAttributes","closestScaledWith","closestScaledHeight","offsetX","offsetY","round","workAroundCollapsingMarginsAcrossSVGElementInWebKitLike","workAroundSafariSometimesNotShowingExternalResources","externalResourcesRequired","workAroundChromeShowingScrollbarsUnderLinuxIfHtmlIsOverflowScroll","serializeAttributes","map","key","convertElementToSvg","serializeToString","foreignObjectAttrs","getSvgForDocument","drawDocumentAsSvg","rasterize","generalDrawError","drawSvgAsImg","drawImageOnCanvas","doDraw","result","operateJavaScriptOnDocument","inlineOptions","inlineScripts","executeJs","inlineReferences","drawResult","rasterizeHTML","getViewportSize","defaultWidth","defaultHeight","fallbackWidth","fallbackHeight","constructOptions","params","viewport","drawDocument","optionalArguments","drawHTML","workAroundFirefoxNotLoadingStylesheetStyles","d","replaceChild","extendedOptions","drawURL","workaround"],"mappings":"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","sourcesContent":["/*! rasterizeHTML.js - v1.3.0 - 2018-03-18\n* http://www.github.com/cburgmer/rasterizeHTML.js\n* Copyright (c) 2018 Christoph Burgmer; Licensed MIT */\n(function (root, factory) {\n  if (root === undefined && window !== undefined) root = window;\n  if (typeof define === 'function' && define.amd) {\n    // AMD. Register as an anonymous module unless amdModuleId is set\n    define([\"url\",\"xmlserializer\",\"sane-domparser-error\",\"inlineresources\"], function (a0,b1,c2,d3) {\n      return (root['rasterizeHTML'] = factory(a0,b1,c2,d3));\n    });\n  } else if (typeof module === 'object' && module.exports) {\n    // Node. Does not work with strict CommonJS, but\n    // only CommonJS-like environments that support module.exports,\n    // like Node.\n    module.exports = factory(require(\"url\"),require(\"xmlserializer\"),require(\"sane-domparser-error\"),require(\"inlineresources\"));\n  } else {\n    root['rasterizeHTML'] = factory(root[\"url\"],root[\"xmlserializer\"],root[\"sanedomparsererror\"],root[\"inlineresources\"]);\n  }\n}(this, function (url, xmlserializer, sanedomparsererror, inlineresources) {\n\nvar util = (function (url) {\n    \"use strict\";\n\n    var module = {};\n\n    var uniqueIdList = [];\n\n    module.joinUrl = function (baseUrl, relUrl) {\n        if (!baseUrl) {\n            return relUrl;\n        }\n        return url.resolve(baseUrl, relUrl);\n    };\n\n    module.getConstantUniqueIdFor = function (element) {\n        // HACK, using a list results in O(n), but how do we hash e.g. a DOM node?\n        if (uniqueIdList.indexOf(element) < 0) {\n            uniqueIdList.push(element);\n        }\n        return uniqueIdList.indexOf(element);\n    };\n\n    module.clone = function (object) {\n        var theClone = {},\n            i;\n        for (i in object) {\n            if (object.hasOwnProperty(i)) {\n                theClone[i] = object[i];\n            }\n        }\n        return theClone;\n    };\n\n    var isObject = function (obj) {\n        return typeof obj === \"object\" && obj !== null;\n    };\n\n    var isCanvas = function (obj) {\n        return isObject(obj) &&\n            Object.prototype.toString.apply(obj).match(/\\[object (Canvas|HTMLCanvasElement)\\]/i);\n    };\n\n    // args: canvas, options\n    module.parseOptionalParameters = function (args) {\n        var parameters = {\n            canvas: null,\n            options: {}\n        };\n\n        if (args[0] == null || isCanvas(args[0])) {\n            parameters.canvas = args[0] || null;\n\n            parameters.options = module.clone(args[1]);\n        } else {\n            parameters.options = module.clone(args[0]);\n        }\n\n        return parameters;\n    };\n\n    return module;\n}(url));\n\n// Proxy objects by monkey patching\nvar proxies = (function (util) {\n    \"use strict\";\n\n    var module = {};\n\n    var monkeyPatchInstanceMethod = function (object, methodName, proxyFunc) {\n        var originalFunc = object[methodName];\n\n        object[methodName] = function () {\n            var args = Array.prototype.slice.call(arguments);\n\n            return proxyFunc.apply(this, [args, originalFunc]);\n        };\n\n        return originalFunc;\n    };\n\n    // Bases all XHR calls on the given base URL\n    module.baseUrlRespectingXhr = function (XHRObject, baseUrl) {\n        var xhrConstructor = function () {\n            var xhr = new XHRObject();\n\n            monkeyPatchInstanceMethod(xhr, 'open', function (args, originalOpen) {\n                var method = args.shift(),\n                    url = args.shift(),\n                    joinedUrl = util.joinUrl(baseUrl, url);\n\n                return originalOpen.apply(this, [method, joinedUrl].concat(args));\n            });\n\n            return xhr;\n        };\n\n        return xhrConstructor;\n    };\n\n    // Provides a convenient way of being notified when all pending XHR calls are finished\n    module.finishNotifyingXhr = function (XHRObject) {\n        var totalXhrCount = 0,\n            doneXhrCount = 0,\n            waitingForPendingToClose = false;\n        var checkAllRequestsFinished;\n\n        var promise = new Promise(function (resolve) {\n            checkAllRequestsFinished = function () {\n                var pendingXhrCount = totalXhrCount - doneXhrCount;\n\n                if (pendingXhrCount <= 0 && waitingForPendingToClose) {\n                    resolve({totalCount: totalXhrCount});\n                }\n            };\n        });\n\n        var xhrConstructor = function () {\n            var xhr = new XHRObject();\n\n            monkeyPatchInstanceMethod(xhr, 'send', function (_, originalSend) {\n                totalXhrCount += 1;\n                return originalSend.apply(this, arguments);\n            });\n\n            xhr.addEventListener('load', function () {\n                doneXhrCount += 1;\n\n                checkAllRequestsFinished();\n            });\n\n            return xhr;\n        };\n\n        xhrConstructor.waitForRequestsToFinish = function () {\n            waitingForPendingToClose = true;\n            checkAllRequestsFinished();\n            return promise;\n        };\n\n        return xhrConstructor;\n    };\n\n    return module;\n}(util));\n\nvar documentUtil = (function () {\n    \"use strict\";\n\n    var module = {};\n\n    var asArray = function (arrayLike) {\n        return Array.prototype.slice.call(arrayLike);\n    };\n\n    module.addClassName = function (element, className) {\n        element.className += ' ' + className;\n    };\n\n    module.addClassNameRecursively = function (element, className) {\n        module.addClassName(element, className);\n\n        if (element.parentNode !== element.ownerDocument) {\n            module.addClassNameRecursively(element.parentNode, className);\n        }\n    };\n\n    var changeCssRule = function (rule, newRuleText) {\n        var styleSheet = rule.parentStyleSheet,\n            ruleIdx = asArray(styleSheet.cssRules).indexOf(rule);\n\n        // Exchange rule with the new text\n        styleSheet.insertRule(newRuleText, ruleIdx+1);\n        styleSheet.deleteRule(ruleIdx);\n    };\n\n    var updateRuleSelector = function (rule, updatedSelector) {\n        var styleDefinitions = rule.cssText.replace(/^[^\\{]+/, ''),\n            newRule = updatedSelector + ' ' + styleDefinitions;\n\n        changeCssRule(rule, newRule);\n    };\n\n    var cssRulesToText = function (cssRules) {\n        return asArray(cssRules).reduce(function (cssText, rule) {\n            return cssText + rule.cssText;\n        }, '');\n    };\n\n    var rewriteStyleContent = function (styleElement) {\n        styleElement.textContent = cssRulesToText(styleElement.sheet.cssRules);\n    };\n\n    var addSheetPropertyToSvgStyleElement = function (svgStyleElement) {\n        var doc = document.implementation.createHTMLDocument(''),\n            cssStyleElement = document.createElement('style');\n\n        cssStyleElement.textContent = svgStyleElement.textContent;\n        // the style will only be parsed once it is added to a document\n        doc.body.appendChild(cssStyleElement);\n\n        svgStyleElement.sheet = cssStyleElement.sheet;\n    };\n\n    var matchingSimpleSelectorsRegex = function (simpleSelectorList) {\n        return '(' +\n            '(?:^|[^.#:\\\\w])' +            // start of string or not a simple selector character,\n            '|' +                          // ... or ...\n            '(?=\\\\W)' +                    // the next character parsed is not an alphabetic character (and thus a natural boundary)\n            ')' +\n            '(' +\n            simpleSelectorList.join('|') + // one out of the given simple selectors\n            ')' +\n            '(?=\\\\W|$)';                   // followed either by a non-alphabetic character or the end of the string\n    };\n\n    var replaceSimpleSelectorsBy = function (element, simpleSelectorList, caseInsensitiveReplaceFunc) {\n        var selectorRegex = matchingSimpleSelectorsRegex(simpleSelectorList);\n\n        asArray(element.querySelectorAll('style')).forEach(function (styleElement) {\n            // SVGStyleElement doesn't have a property sheet in Safari, we need some workaround here\n            // more details can be found here: https://github.com/cburgmer/rasterizeHTML.js/issues/158\n            if (typeof styleElement.sheet === 'undefined') {\n                addSheetPropertyToSvgStyleElement(styleElement);\n            }\n\n            var matchingRules = asArray(styleElement.sheet.cssRules).filter(function (rule) {\n                return rule.selectorText && new RegExp(selectorRegex, 'i').test(rule.selectorText);\n            });\n\n            if (matchingRules.length) {\n                matchingRules.forEach(function (rule) {\n                    var newSelector = rule.selectorText.replace(new RegExp(selectorRegex, 'gi'),\n                                                             function (_, prefixMatch, selectorMatch) {\n                        return prefixMatch + caseInsensitiveReplaceFunc(selectorMatch);\n                    });\n\n                    if (newSelector !== rule.selectorText) {\n                        updateRuleSelector(rule, newSelector);\n                    }\n                });\n\n                rewriteStyleContent(styleElement);\n            }\n        });\n    };\n\n    module.rewriteCssSelectorWith = function (element, oldSelector, newSelector) {\n        replaceSimpleSelectorsBy(element, [oldSelector], function () {\n            return newSelector;\n        });\n    };\n\n    module.lowercaseCssTypeSelectors = function (element, matchingTagNames) {\n        replaceSimpleSelectorsBy(element, matchingTagNames, function (match) {\n            return match.toLowerCase();\n        });\n    };\n\n    module.findHtmlOnlyNodeNames = function (element) {\n        var treeWalker = element.ownerDocument.createTreeWalker(element, NodeFilter.SHOW_ELEMENT),\n            htmlNodeNames = {},\n            nonHtmlNodeNames = {},\n            currentTagName;\n\n        do {\n            currentTagName = treeWalker.currentNode.tagName.toLowerCase();\n            if (treeWalker.currentNode.namespaceURI === 'http://www.w3.org/1999/xhtml') {\n                htmlNodeNames[currentTagName] = true;\n            } else {\n                nonHtmlNodeNames[currentTagName] = true;\n            }\n        } while(treeWalker.nextNode());\n\n        return Object.keys(htmlNodeNames).filter(function (tagName) {\n            return !nonHtmlNodeNames[tagName];\n        });\n    };\n\n    return module;\n}());\n\nvar documentHelper = (function (documentUtil) {\n    \"use strict\";\n\n    var module = {};\n\n    var asArray = function (arrayLike) {\n        return Array.prototype.slice.call(arrayLike);\n    };\n\n    var cascadingAction = {\n        active: true,\n        hover: true,\n        focus: false,\n        target: false\n    };\n\n    module.fakeUserAction = function (element, selector, action) {\n        var elem = element.querySelector(selector),\n            pseudoClass = ':' + action,\n            fakeActionClass = 'rasterizehtml' + action;\n        if (! elem) {\n            return;\n        }\n\n        if (cascadingAction[action]) {\n            documentUtil.addClassNameRecursively(elem, fakeActionClass);\n        } else {\n            documentUtil.addClassName(elem, fakeActionClass);\n        }\n        documentUtil.rewriteCssSelectorWith(element, pseudoClass, '.' + fakeActionClass);\n    };\n\n    module.persistInputValues = function (doc) {\n        var inputs = doc.querySelectorAll('input'),\n            textareas = doc.querySelectorAll('textarea'),\n            isCheckable = function (input) {\n                return input.type === 'checkbox' || input.type === 'radio';\n            };\n\n        asArray(inputs).filter(isCheckable)\n            .forEach(function (input) {\n                if (input.checked) {\n                    input.setAttribute('checked', '');\n                } else {\n                    input.removeAttribute('checked');\n                }\n            });\n\n        asArray(inputs).filter(function (input) { return !isCheckable(input); })\n            .forEach(function (input) {\n                input.setAttribute('value', input.value);\n            });\n\n        asArray(textareas)\n            .forEach(function (textarea) {\n                textarea.textContent = textarea.value;\n            });\n    };\n\n    module.rewriteTagNameSelectorsToLowerCase = function (element) {\n        documentUtil.lowercaseCssTypeSelectors(element, documentUtil.findHtmlOnlyNodeNames(element));\n    };\n\n    return module;\n}(documentUtil));\n\nvar browser = (function (util, proxies, sanedomparsererror, theWindow) {\n    \"use strict\";\n\n    var module = {};\n\n    var createHiddenElement = function (doc, tagName, width, height) {\n        var element = doc.createElement(tagName);\n        // 'display: none' doesn't cut it, as browsers seem to be lazy loading CSS\n        element.style.visibility = \"hidden\";\n        element.style.width = width + \"px\";\n        element.style.height = height + \"px\";\n        element.style.position = \"absolute\";\n        element.style.top = (-10000 - height) + \"px\";\n        element.style.left = (-10000 - width) + \"px\";\n        // We need to add the element to the document so that its content gets loaded\n        doc.getElementsByTagName(\"body\")[0].appendChild(element);\n        return element;\n    };\n\n    var wait = function (timeout) {\n        if (timeout > 0) {\n            return new Promise(function (resolve) {\n                setTimeout(resolve, timeout);\n            });\n        } else {\n            return Promise.resolve();\n        }\n    };\n\n    module.executeJavascript = function (element, options) {\n        return new Promise(function (resolve) {\n            var iframe = createHiddenElement(theWindow.document, \"iframe\", options.width, options.height),\n                html = element.outerHTML,\n                iframeErrorsMessages = [],\n                executeJsTimeout = options.executeJsTimeout || 0;\n\n            var doResolve = function () {\n                var doc = iframe.contentDocument;\n                theWindow.document.getElementsByTagName(\"body\")[0].removeChild(iframe);\n                resolve({\n                    document: doc,\n                    errors: iframeErrorsMessages\n                });\n            };\n\n            var xhr = iframe.contentWindow.XMLHttpRequest,\n                finishNotifyXhrProxy = proxies.finishNotifyingXhr(xhr),\n                baseUrlXhrProxy = proxies.baseUrlRespectingXhr(finishNotifyXhrProxy, options.baseUrl);\n\n            iframe.onload = function () {\n                wait(executeJsTimeout)\n                    .then(finishNotifyXhrProxy.waitForRequestsToFinish)\n                    .then(doResolve);\n            };\n\n            iframe.contentDocument.open();\n            iframe.contentWindow.XMLHttpRequest = baseUrlXhrProxy;\n            iframe.contentWindow.onerror = function (msg) {\n                iframeErrorsMessages.push({\n                    resourceType: \"scriptExecution\",\n                    msg: msg\n                });\n            };\n\n            iframe.contentDocument.write('<!DOCTYPE html>');\n            iframe.contentDocument.write(html);\n            iframe.contentDocument.close();\n        });\n    };\n\n    var createHiddenSandboxedIFrame = function (doc, width, height) {\n        var iframe = doc.createElement('iframe');\n        iframe.style.width = width + \"px\";\n        iframe.style.height = height + \"px\";\n        // 'display: none' doesn't cut it, as browsers seem to be lazy loading content\n        iframe.style.visibility = \"hidden\";\n        iframe.style.position = \"absolute\";\n        iframe.style.top = (-10000 - height) + \"px\";\n        iframe.style.left = (-10000 - width) + \"px\";\n        // make sure content gets exact width independent of box-sizing value\n        iframe.style.borderWidth = 0;\n        // Don't execute JS, all we need from sandboxing is access to the iframe's document\n        iframe.sandbox = 'allow-same-origin';\n        // Don't include a scrollbar on Linux\n        iframe.scrolling = 'no';\n        return iframe;\n    };\n\n    var createIframeWithSizeAtZoomLevel1 = function (width, height, zoom) {\n        var scaledViewportWidth = Math.floor(width / zoom),\n            scaledViewportHeight = Math.floor(height / zoom);\n\n        return createHiddenSandboxedIFrame(theWindow.document, scaledViewportWidth, scaledViewportHeight);\n    };\n\n    var calculateZoomedContentSizeAndRoundUp = function (actualViewport, requestedWidth, requestedHeight, zoom) {\n        return {\n            width: Math.max(actualViewport.width * zoom, requestedWidth),\n            height: Math.max(actualViewport.height * zoom, requestedHeight)\n        };\n    };\n\n    var selectElementOrDescendant = function (element, selector) {\n        var descendant = element.querySelector(selector);\n        if (descendant) {\n            return descendant;\n        } else if (element.ownerDocument.querySelector(selector) === element) {\n            return element;\n        }\n\n        throw {\n            message: \"Clipping selector not found\"\n        };\n    };\n\n    var calculateContentSize = function (rootElement, selector, requestedWidth, requestedHeight, zoom) {\n        // clientWidth/clientHeight needed for PhantomJS\n        var actualViewportWidth = Math.max(rootElement.scrollWidth, rootElement.clientWidth),\n            actualViewportHeight = Math.max(rootElement.scrollHeight, rootElement.clientHeight),\n            top, left, originalWidth, originalHeight, rootFontSize,\n            element, rect, contentSize;\n\n        if (selector) {\n            element = selectElementOrDescendant(rootElement, selector);\n\n            rect = element.getBoundingClientRect();\n\n            top = rect.top;\n            left = rect.left;\n            originalWidth = rect.width;\n            originalHeight = rect.height;\n        } else {\n            top = 0;\n            left = 0;\n            originalWidth = actualViewportWidth;\n            originalHeight = actualViewportHeight;\n        }\n\n        contentSize = calculateZoomedContentSizeAndRoundUp({\n                width: originalWidth,\n                height: originalHeight\n            },\n            requestedWidth,\n            requestedHeight,\n            zoom);\n\n        rootFontSize = theWindow.getComputedStyle(rootElement.ownerDocument.documentElement).fontSize;\n\n        return {\n            left: left,\n            top: top,\n            width: contentSize.width,\n            height: contentSize.height,\n            viewportWidth: actualViewportWidth,\n            viewportHeight: actualViewportHeight,\n\n            rootFontSize: rootFontSize\n        };\n    };\n\n    var findCorrelatingElement = function (element, documentClone) {\n        var tagName = element.tagName;\n        // Stupid but simple method: find first match. Should work for a single HTML element, and any other element given as root\n        return documentClone.querySelector(tagName);\n    };\n\n    var elementToFullHtmlDocument = function (element) {\n        var tagName = element.tagName.toLowerCase();\n        if (tagName === 'html' || tagName === 'body') {\n            return element.outerHTML;\n        }\n\n        // Simple hack: hide the body from sizing, otherwise browser would apply a 8px margin\n        return '<body style=\"margin: 0;\">' + element.outerHTML + '</body>';\n    };\n\n    module.calculateDocumentContentSize = function (element, options) {\n        return new Promise(function (resolve, reject) {\n            var zoom = options.zoom || 1,\n                iframe;\n\n\n            iframe = createIframeWithSizeAtZoomLevel1(options.width, options.height, zoom);\n            // We need to add the element to the document so that its content gets loaded\n            theWindow.document.getElementsByTagName(\"body\")[0].appendChild(iframe);\n\n            iframe.onload = function () {\n                var doc = iframe.contentDocument,\n                    size;\n\n                try {\n                    size = calculateContentSize(findCorrelatingElement(element, doc), options.clip, options.width, options.height, zoom);\n\n                    resolve(size);\n                } catch (e) {\n                    reject(e);\n                } finally {\n                    theWindow.document.getElementsByTagName(\"body\")[0].removeChild(iframe);\n                }\n            };\n\n            // srcdoc doesn't work in PhantomJS yet\n            iframe.contentDocument.open();\n            iframe.contentDocument.write('<!DOCTYPE html>');\n            iframe.contentDocument.write(elementToFullHtmlDocument(element));\n            iframe.contentDocument.close();\n        });\n    };\n\n    module.parseHtmlFragment = function (htmlFragment) {\n        var doc = theWindow.document.implementation.createHTMLDocument('');\n        doc.documentElement.innerHTML = htmlFragment;\n\n        var element = doc.querySelector('body').firstChild;\n\n        if (!element) {\n            throw \"Invalid source\";\n        }\n\n        return element;\n    };\n\n    var addHTMLTagAttributes = function (doc, html) {\n        var attributeMatch = /<html((?:\\s+[^>]*)?)>/im.exec(html),\n            helperDoc = theWindow.document.implementation.createHTMLDocument(''),\n            htmlTagSubstitute,\n            i, elementSubstitute, attribute;\n\n        if (!attributeMatch) {\n            return;\n        }\n\n        htmlTagSubstitute = '<div' + attributeMatch[1] + '></div>';\n        helperDoc.documentElement.innerHTML = htmlTagSubstitute;\n        elementSubstitute = helperDoc.querySelector('div');\n\n        for (i = 0; i < elementSubstitute.attributes.length; i++) {\n            attribute = elementSubstitute.attributes[i];\n            doc.documentElement.setAttribute(attribute.name, attribute.value);\n        }\n    };\n\n    module.parseHTML = function (html) {\n        // We should be using the DOMParser, but it is not supported in older browsers\n        var doc = theWindow.document.implementation.createHTMLDocument('');\n        doc.documentElement.innerHTML = html;\n\n        addHTMLTagAttributes(doc, html);\n        return doc;\n    };\n\n    var failOnInvalidSource = function (doc) {\n        try {\n            return sanedomparsererror.failOnParseError(doc);\n        } catch (e) {\n            throw {\n                message: \"Invalid source\",\n                originalError: e\n            };\n        }\n    };\n\n    module.validateXHTML = function (xhtml) {\n        var p = new DOMParser(),\n            doc = p.parseFromString(xhtml, \"application/xml\");\n\n        failOnInvalidSource(doc);\n    };\n\n    var lastCacheDate = null;\n\n    var getUncachableURL = function (url, cache) {\n        if (cache === 'none' || cache === 'repeated') {\n            if (lastCacheDate === null || cache !== 'repeated') {\n                lastCacheDate = Date.now();\n            }\n            return url + \"?_=\" + lastCacheDate;\n        } else {\n            return url;\n        }\n    };\n\n    var doDocumentLoad = function (url, options) {\n        return new Promise(function (resolve, reject) {\n            var xhr = new window.XMLHttpRequest(),\n                joinedUrl = util.joinUrl(options.baseUrl, url),\n                augmentedUrl = getUncachableURL(joinedUrl, options.cache),\n                doReject = function (e) {\n                    reject({\n                        message: \"Unable to load page\",\n                        originalError: e\n                    });\n                };\n\n            xhr.addEventListener(\"load\", function () {\n                if (xhr.status === 200 || xhr.status === 0) {\n                    resolve(xhr.responseXML);\n                } else {\n                    doReject(xhr.statusText);\n                }\n            }, false);\n\n            xhr.addEventListener(\"error\", function (e) {\n                doReject(e);\n            }, false);\n\n            try {\n                xhr.open('GET', augmentedUrl, true);\n                xhr.responseType = \"document\";\n                xhr.send(null);\n            } catch (e) {\n                doReject(e);\n            }\n        });\n    };\n\n    module.loadDocument = function (url, options) {\n        return doDocumentLoad(url, options)\n            .then(function (doc) {\n                return failOnInvalidSource(doc);\n            });\n    };\n\n    return module;\n}(util, proxies, sanedomparsererror, window));\n\nvar svg2image = (function (window) {\n    \"use strict\";\n\n    var module = {};\n\n    var urlForSvg = function (svg, useBlobs) {\n        if (useBlobs) {\n            return URL.createObjectURL(new Blob([svg], {\"type\": \"image/svg+xml\"}));\n        } else {\n            return \"data:image/svg+xml;charset=utf-8,\" + encodeURIComponent(svg);\n        }\n    };\n\n    var cleanUpUrl = function (url) {\n        if (url instanceof Blob) {\n            URL.revokeObjectURL(url);\n        }\n    };\n\n    var simpleForeignObjectSvg = '<svg xmlns=\"http://www.w3.org/2000/svg\" width=\"1\" height=\"1\"><foreignObject></foreignObject></svg>';\n\n    var supportsReadingObjectFromCanvas = function (url) {\n        return new Promise(function (resolve, reject) {\n            var canvas = document.createElement(\"canvas\"),\n                image = new Image();\n\n            image.onload = function () {\n                var context = canvas.getContext(\"2d\");\n                try {\n                    context.drawImage(image, 0, 0);\n                    // This will fail in Chrome & Safari\n                    canvas.toDataURL(\"image/png\");\n                    resolve(true);\n                } catch (e) {\n                    resolve(false);\n                }\n            };\n            image.onerror = reject;\n            image.src = url;\n        });\n    };\n\n    var readingBackFromCanvasBenefitsFromOldSchoolDataUris = function () {\n        // Check for work around for https://code.google.com/p/chromium/issues/detail?id=294129\n        var blobUrl = urlForSvg(simpleForeignObjectSvg, true);\n        return supportsReadingObjectFromCanvas(blobUrl)\n            .then(function (supportsReadingFromBlobs) {\n                cleanUpUrl(blobUrl);\n                if (supportsReadingFromBlobs) {\n                    return false;\n                }\n                return supportsReadingObjectFromCanvas(urlForSvg(simpleForeignObjectSvg, false))\n                    .then(function (s) {\n                        return s;\n                    });\n            }, function () {\n                return false;\n            });\n    };\n\n    var supportsBlobBuilding = function () {\n        if (window.Blob) {\n            // Available as constructor only in newer builds for all browsers\n            try {\n                new Blob(['<b></b>'], { \"type\" : \"text/xml\" });\n                return true;\n            } catch (err) {}\n        }\n        return false;\n    };\n\n    var checkBlobSupport = function () {\n        return new Promise(function (resolve, reject) {\n            if (supportsBlobBuilding() && window.URL) {\n                readingBackFromCanvasBenefitsFromOldSchoolDataUris()\n                    .then(function (doesBenefit) {\n                        resolve(! doesBenefit);\n                    }, function () {\n                        reject();\n                    });\n            } else {\n                resolve(false);\n            }\n        });\n    };\n\n    var checkForBlobsResult;\n\n    var checkForBlobs = function () {\n        if (checkForBlobsResult === undefined) {\n            checkForBlobsResult = checkBlobSupport();\n        }\n\n        return checkForBlobsResult;\n    };\n\n    var buildImageUrl = function (svg) {\n        return checkForBlobs().then(function (useBlobs) {\n            return urlForSvg(svg, useBlobs);\n        });\n    };\n\n    module.renderSvg = function (svg) {\n        return new Promise(function (resolve, reject) {\n            var url, image,\n                resetEventHandlers = function () {\n                    image.onload = null;\n                    image.onerror = null;\n                },\n                cleanUp = function () {\n                    if (url) {\n                        cleanUpUrl(url);\n                    }\n                };\n\n            image = new Image();\n            image.onload = function() {\n                resetEventHandlers();\n                cleanUp();\n\n                resolve(image);\n            };\n            image.onerror = function () {\n                cleanUp();\n\n                // Webkit calls the onerror handler if the SVG is faulty\n                reject();\n            };\n\n            buildImageUrl(svg).then(function (imageUrl) {\n                url = imageUrl;\n                image.src = url;\n            }, reject);\n        });\n    };\n\n    return module;\n}(window));\n\nvar document2svg = (function (util, browser, documentHelper, xmlserializer) {\n    \"use strict\";\n\n    var module = {};\n\n    var svgAttributes = function (size, zoom) {\n        var zoomFactor = zoom || 1;\n\n        var attributes = {\n            width: size.width,\n            height: size.height,\n            'font-size': size.rootFontSize\n        };\n\n        if (zoomFactor !== 1) {\n            attributes.style = 'transform:scale(' + zoomFactor + '); transform-origin: 0 0;';\n        }\n\n        return attributes;\n    };\n\n    var foreignObjectAttributes = function (size) {\n        var closestScaledWith, closestScaledHeight,\n            offsetX, offsetY;\n\n        closestScaledWith = Math.round(size.viewportWidth);\n        closestScaledHeight = Math.round(size.viewportHeight);\n\n        offsetX = -size.left;\n        offsetY = -size.top;\n\n        var attributes = {\n             'x': offsetX,\n             'y': offsetY,\n             'width': closestScaledWith,\n             'height': closestScaledHeight\n        };\n\n        return attributes;\n    };\n\n    var workAroundCollapsingMarginsAcrossSVGElementInWebKitLike = function (attributes) {\n        var style = attributes.style || '';\n        attributes.style = style + 'float: left;';\n    };\n\n    var workAroundSafariSometimesNotShowingExternalResources = function (attributes) {\n        /* Let's hope that works some magic. The spec says SVGLoad only fires\n         * now when all externals are available.\n         * http://www.w3.org/TR/SVG/struct.html#ExternalResourcesRequired */\n        attributes.externalResourcesRequired = true;\n    };\n\n    var workAroundChromeShowingScrollbarsUnderLinuxIfHtmlIsOverflowScroll = function () {\n        return '<style scoped=\"\">html::-webkit-scrollbar { display: none; }</style>';\n    };\n\n    var serializeAttributes = function (attributes) {\n        var keys = Object.keys(attributes);\n        if (!keys.length) {\n            return '';\n        }\n\n        return ' ' + keys.map(function (key) {\n            return key + '=\"' + attributes[key] + '\"';\n        }).join(' ');\n    };\n\n    var convertElementToSvg = function (element, size, zoomFactor) {\n        var xhtml = xmlserializer.serializeToString(element);\n\n        browser.validateXHTML(xhtml);\n\n        var foreignObjectAttrs = foreignObjectAttributes(size);\n        workAroundCollapsingMarginsAcrossSVGElementInWebKitLike(foreignObjectAttrs);\n        workAroundSafariSometimesNotShowingExternalResources(foreignObjectAttrs);\n\n        return (\n            '<svg xmlns=\"http://www.w3.org/2000/svg\"' +\n                serializeAttributes(svgAttributes(size, zoomFactor)) +\n                '>' +\n                workAroundChromeShowingScrollbarsUnderLinuxIfHtmlIsOverflowScroll() +\n                '<foreignObject' + serializeAttributes(foreignObjectAttrs) + '>' +\n                xhtml +\n                '</foreignObject>' +\n                '</svg>'\n        );\n    };\n\n    module.getSvgForDocument = function (element, size, zoomFactor) {\n        documentHelper.rewriteTagNameSelectorsToLowerCase(element);\n\n        return convertElementToSvg(element, size, zoomFactor);\n    };\n\n    module.drawDocumentAsSvg = function (element, options) {\n        ['hover', 'active', 'focus', 'target'].forEach(function (action) {\n            if (options[action]) {\n                documentHelper.fakeUserAction(element, options[action], action);\n            }\n        });\n\n        return browser.calculateDocumentContentSize(element, options)\n            .then(function (size) {\n                return module.getSvgForDocument(element, size, options.zoom);\n            });\n    };\n\n    return module;\n}(util, browser, documentHelper, xmlserializer));\n\nvar rasterize = (function (util, browser, documentHelper, document2svg, svg2image, inlineresources) {\n    \"use strict\";\n\n    var module = {};\n\n    var generalDrawError = function (e) {\n        return {\n            message: \"Error rendering page\",\n            originalError: e\n        };\n    };\n\n    var drawSvgAsImg = function (svg) {\n        return svg2image.renderSvg(svg)\n            .then(function (image) {\n                return {\n                    image: image,\n                    svg: svg\n                };\n            }, function (e) {\n                throw generalDrawError(e);\n            });\n    };\n\n    var drawImageOnCanvas = function (image, canvas) {\n        try {\n            canvas.getContext(\"2d\").drawImage(image, 0, 0);\n        } catch (e) {\n            // Firefox throws a 'NS_ERROR_NOT_AVAILABLE' if the SVG is faulty\n            throw generalDrawError(e);\n        }\n    };\n\n    var doDraw = function (element, canvas, options) {\n        return document2svg.drawDocumentAsSvg(element, options)\n            .then(drawSvgAsImg)\n            .then(function (result) {\n                if (canvas) {\n                    drawImageOnCanvas(result.image, canvas);\n                }\n\n                return result;\n            });\n    };\n\n    var operateJavaScriptOnDocument = function (element, options) {\n        return browser.executeJavascript(element, options)\n            .then(function (result) {\n                var document = result.document;\n                documentHelper.persistInputValues(document);\n\n                return {\n                    document: document,\n                    errors: result.errors\n                };\n            });\n    };\n\n    module.rasterize = function (element, canvas, options) {\n        var inlineOptions;\n\n        inlineOptions = util.clone(options);\n        inlineOptions.inlineScripts = options.executeJs === true;\n\n        return inlineresources.inlineReferences(element, inlineOptions)\n            .then(function (errors) {\n                if (options.executeJs) {\n                    return operateJavaScriptOnDocument(element, options)\n                        .then(function (result) {\n                            return {\n                                element: result.document.documentElement,\n                                errors: errors.concat(result.errors)\n                            };\n                        });\n                } else {\n                    return {\n                        element: element,\n                        errors: errors\n                    };\n                }\n            }).then(function (result) {\n                return doDraw(result.element, canvas, options)\n                    .then(function (drawResult) {\n                        return {\n                            image: drawResult.image,\n                            svg: drawResult.svg,\n                            errors: result.errors\n                        };\n                    });\n            });\n    };\n\n    return module;\n}(util, browser, documentHelper, document2svg, svg2image, inlineresources));\n\nvar rasterizeHTML = (function (util, browser, rasterize) {\n    \"use strict\";\n\n    var module = {};\n\n    var getViewportSize = function (canvas, options) {\n        var defaultWidth = 300,\n            defaultHeight = 200,\n            fallbackWidth = canvas ? canvas.width : defaultWidth,\n            fallbackHeight = canvas ? canvas.height : defaultHeight,\n            width = options.width !== undefined ? options.width : fallbackWidth,\n            height = options.height !== undefined ? options.height : fallbackHeight;\n\n        return {\n            width: width,\n            height: height\n        };\n    };\n\n    var constructOptions = function (params) {\n        var viewport = getViewportSize(params.canvas, params.options),\n            options;\n\n        options = util.clone(params.options);\n        options.width = viewport.width;\n        options.height = viewport.height;\n\n        return options;\n    };\n\n    /**\n     * Draws a Document to the canvas.\n     * rasterizeHTML.drawDocument( document [, canvas] [, options] ).then(function (result) { ... });\n     */\n    module.drawDocument = function () {\n        var doc = arguments[0],\n            optionalArguments = Array.prototype.slice.call(arguments, 1),\n            params = util.parseOptionalParameters(optionalArguments);\n\n        var element = doc.documentElement ? doc.documentElement : doc;\n\n        return rasterize.rasterize(element, params.canvas, constructOptions(params));\n    };\n\n    var drawHTML = function (html, canvas, options) {\n        var doc = browser.parseHTML(html);\n\n        return module.drawDocument(doc, canvas, options);\n    };\n\n    /**\n     * Draws a HTML string to the canvas.\n     * rasterizeHTML.drawHTML( html [, canvas] [, options] ).then(function (result) { ... });\n     */\n    module.drawHTML = function () {\n        var html = arguments[0],\n            optionalArguments = Array.prototype.slice.call(arguments, 1),\n            params = util.parseOptionalParameters(optionalArguments);\n\n        return drawHTML(html, params.canvas, params.options);\n    };\n\n    // work around https://bugzilla.mozilla.org/show_bug.cgi?id=925493\n    var workAroundFirefoxNotLoadingStylesheetStyles = function (doc, url, options) {\n        var d = document.implementation.createHTMLDocument('');\n        d.replaceChild(doc.documentElement, d.documentElement);\n\n        var extendedOptions = options ? util.clone(options) : {};\n\n        if (!options.baseUrl) {\n            extendedOptions.baseUrl = url;\n        }\n\n        return {\n            document: d,\n            options: extendedOptions\n        };\n    };\n\n    var drawURL = function (url, canvas, options) {\n        return browser.loadDocument(url, options)\n            .then(function (doc) {\n                var workaround = workAroundFirefoxNotLoadingStylesheetStyles(doc, url, options);\n                return module.drawDocument(workaround.document, canvas, workaround.options);\n            });\n    };\n\n    /**\n     * Draws a page to the canvas.\n     * rasterizeHTML.drawURL( url [, canvas] [, options] ).then(function (result) { ... });\n     */\n    module.drawURL = function () {\n        var url = arguments[0],\n            optionalArguments = Array.prototype.slice.call(arguments, 1),\n            params = util.parseOptionalParameters(optionalArguments);\n\n        return drawURL(url, params.canvas, params.options);\n    };\n\n    return module;\n}(util, browser, rasterize));\n\nreturn rasterizeHTML;\n\n}));\n"]},"metadata":{},"sourceType":"script"}