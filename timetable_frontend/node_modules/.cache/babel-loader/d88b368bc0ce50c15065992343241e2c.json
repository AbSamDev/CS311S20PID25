{"ast":null,"code":"\"use strict\";\n\nvar util = require('./util'),\n    inlineImage = require('./inlineImage'),\n    inlineScript = require('./inlineScript'),\n    inlineCss = require('./inlineCss'),\n    cssSupport = require('./cssSupport');\n\nvar getUrlBasePath = function (url) {\n  return util.joinUrl(url, '.');\n};\n\nvar parameterHashFunction = function (params) {\n  // HACK JSON.stringify is poor man's hashing;\n  // same objects might not receive same result as key order is not guaranteed\n  var a = params.map(function (param, idx) {\n    // Only include options relevant for method\n    if (idx === params.length - 1) {\n      param = {\n        // Two different HTML pages on the same path level have the same base path, but a different URL\n        baseUrl: getUrlBasePath(param.baseUrl)\n      };\n    }\n\n    return JSON.stringify(param);\n  });\n  return a;\n};\n\nvar memoizeFunctionOnCaching = function (func, options) {\n  if (options.cache !== false && options.cache !== 'none' && options.cacheBucket) {\n    return util.memoize(func, parameterHashFunction, options.cacheBucket);\n  } else {\n    return func;\n  }\n};\n/* Style inlining */\n\n\nvar requestExternalsForStylesheet = function (styleContent, alreadyLoadedCssUrls, options) {\n  var cssRules = cssSupport.rulesForCssText(styleContent);\n  return inlineCss.loadCSSImportsForRules(cssRules, alreadyLoadedCssUrls, options).then(function (cssImportResult) {\n    return inlineCss.loadAndInlineCSSResourcesForRules(cssRules, options).then(function (cssResourcesResult) {\n      var errors = cssImportResult.errors.concat(cssResourcesResult.errors),\n          hasChanges = cssImportResult.hasChanges || cssResourcesResult.hasChanges;\n\n      if (hasChanges) {\n        styleContent = cssSupport.cssRulesToText(cssRules);\n      }\n\n      return {\n        hasChanges: hasChanges,\n        content: styleContent,\n        errors: errors\n      };\n    });\n  });\n};\n\nvar loadAndInlineCssForStyle = function (style, options, alreadyLoadedCssUrls) {\n  var styleContent = style.textContent,\n      processExternals = memoizeFunctionOnCaching(requestExternalsForStylesheet, options);\n  return processExternals(styleContent, alreadyLoadedCssUrls, options).then(function (result) {\n    if (result.hasChanges) {\n      style.childNodes[0].nodeValue = result.content;\n    }\n\n    return util.cloneArray(result.errors);\n  });\n};\n\nvar getCssStyleElements = function (doc) {\n  var styles = doc.getElementsByTagName(\"style\");\n  return Array.prototype.filter.call(styles, function (style) {\n    return !style.attributes.type || style.attributes.type.value === \"text/css\";\n  });\n};\n\nexports.loadAndInlineStyles = function (doc, options) {\n  var styles = getCssStyleElements(doc),\n      allErrors = [],\n      alreadyLoadedCssUrls = [],\n      inlineOptions;\n  inlineOptions = util.clone(options);\n  inlineOptions.baseUrl = inlineOptions.baseUrl || util.getDocumentBaseUrl(doc);\n  return Promise.all(styles.map(function (style) {\n    return loadAndInlineCssForStyle(style, inlineOptions, alreadyLoadedCssUrls).then(function (errors) {\n      allErrors = allErrors.concat(errors);\n    });\n  })).then(function () {\n    return allErrors;\n  });\n};\n/* CSS link inlining */\n\n\nvar substituteLinkWithInlineStyle = function (oldLinkNode, styleContent) {\n  var parent = oldLinkNode.parentNode,\n      styleNode;\n  styleContent = styleContent.trim();\n\n  if (styleContent) {\n    styleNode = oldLinkNode.ownerDocument.createElement(\"style\");\n    styleNode.type = \"text/css\";\n    styleNode.appendChild(oldLinkNode.ownerDocument.createTextNode(styleContent));\n    parent.insertBefore(styleNode, oldLinkNode);\n  }\n\n  parent.removeChild(oldLinkNode);\n};\n\nvar requestStylesheetAndInlineResources = function (url, options) {\n  return util.ajax(url, options).then(function (content) {\n    var cssRules = cssSupport.rulesForCssText(content);\n    return {\n      content: content,\n      cssRules: cssRules\n    };\n  }).then(function (result) {\n    var hasChangesFromPathAdjustment = inlineCss.adjustPathsOfCssResources(url, result.cssRules);\n    return {\n      content: result.content,\n      cssRules: result.cssRules,\n      hasChanges: hasChangesFromPathAdjustment\n    };\n  }).then(function (result) {\n    return inlineCss.loadCSSImportsForRules(result.cssRules, [], options).then(function (cssImportResult) {\n      return {\n        content: result.content,\n        cssRules: result.cssRules,\n        hasChanges: result.hasChanges || cssImportResult.hasChanges,\n        errors: cssImportResult.errors\n      };\n    });\n  }).then(function (result) {\n    return inlineCss.loadAndInlineCSSResourcesForRules(result.cssRules, options).then(function (cssResourcesResult) {\n      return {\n        content: result.content,\n        cssRules: result.cssRules,\n        hasChanges: result.hasChanges || cssResourcesResult.hasChanges,\n        errors: result.errors.concat(cssResourcesResult.errors)\n      };\n    });\n  }).then(function (result) {\n    var content = result.content;\n\n    if (result.hasChanges) {\n      content = cssSupport.cssRulesToText(result.cssRules);\n    }\n\n    return {\n      content: content,\n      errors: result.errors\n    };\n  });\n};\n\nvar loadLinkedCSS = function (link, options) {\n  var cssHref = link.attributes.href.value,\n      documentBaseUrl = util.getDocumentBaseUrl(link.ownerDocument),\n      ajaxOptions = util.clone(options);\n\n  if (!ajaxOptions.baseUrl && documentBaseUrl) {\n    ajaxOptions.baseUrl = documentBaseUrl;\n  }\n\n  var processStylesheet = memoizeFunctionOnCaching(requestStylesheetAndInlineResources, options);\n  return processStylesheet(cssHref, ajaxOptions).then(function (result) {\n    return {\n      content: result.content,\n      errors: util.cloneArray(result.errors)\n    };\n  });\n};\n\nvar getCssStylesheetLinks = function (doc) {\n  var links = doc.getElementsByTagName(\"link\");\n  return Array.prototype.filter.call(links, function (link) {\n    return link.attributes.rel && link.attributes.rel.value === \"stylesheet\" && (!link.attributes.type || link.attributes.type.value === \"text/css\");\n  });\n};\n\nexports.loadAndInlineCssLinks = function (doc, options) {\n  var links = getCssStylesheetLinks(doc),\n      errors = [];\n  return Promise.all(links.map(function (link) {\n    return loadLinkedCSS(link, options).then(function (result) {\n      substituteLinkWithInlineStyle(link, result.content + \"\\n\");\n      errors = errors.concat(result.errors);\n    }, function (e) {\n      errors.push({\n        resourceType: \"stylesheet\",\n        url: e.url,\n        msg: \"Unable to load stylesheet \" + e.url\n      });\n    });\n  })).then(function () {\n    return errors;\n  });\n};\n/* Main */\n\n\nexports.loadAndInlineImages = inlineImage.inline;\nexports.loadAndInlineScript = inlineScript.inline;\n\nexports.inlineReferences = function (doc, options) {\n  var allErrors = [],\n      inlineFuncs = [exports.loadAndInlineImages, exports.loadAndInlineStyles, exports.loadAndInlineCssLinks];\n\n  if (options.inlineScripts !== false) {\n    inlineFuncs.push(exports.loadAndInlineScript);\n  }\n\n  return Promise.all(inlineFuncs.map(function (func) {\n    return func(doc, options).then(function (errors) {\n      allErrors = allErrors.concat(errors);\n    });\n  })).then(function () {\n    return allErrors;\n  });\n};","map":{"version":3,"sources":["D:/act-back original/timetable_frontend/node_modules/inlineresources/src/inline.js"],"names":["util","require","inlineImage","inlineScript","inlineCss","cssSupport","getUrlBasePath","url","joinUrl","parameterHashFunction","params","a","map","param","idx","length","baseUrl","JSON","stringify","memoizeFunctionOnCaching","func","options","cache","cacheBucket","memoize","requestExternalsForStylesheet","styleContent","alreadyLoadedCssUrls","cssRules","rulesForCssText","loadCSSImportsForRules","then","cssImportResult","loadAndInlineCSSResourcesForRules","cssResourcesResult","errors","concat","hasChanges","cssRulesToText","content","loadAndInlineCssForStyle","style","textContent","processExternals","result","childNodes","nodeValue","cloneArray","getCssStyleElements","doc","styles","getElementsByTagName","Array","prototype","filter","call","attributes","type","value","exports","loadAndInlineStyles","allErrors","inlineOptions","clone","getDocumentBaseUrl","Promise","all","substituteLinkWithInlineStyle","oldLinkNode","parent","parentNode","styleNode","trim","ownerDocument","createElement","appendChild","createTextNode","insertBefore","removeChild","requestStylesheetAndInlineResources","ajax","hasChangesFromPathAdjustment","adjustPathsOfCssResources","loadLinkedCSS","link","cssHref","href","documentBaseUrl","ajaxOptions","processStylesheet","getCssStylesheetLinks","links","rel","loadAndInlineCssLinks","e","push","resourceType","msg","loadAndInlineImages","inline","loadAndInlineScript","inlineReferences","inlineFuncs","inlineScripts"],"mappings":"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","sourcesContent":["\"use strict\";\n\nvar util = require('./util'),\n    inlineImage = require('./inlineImage'),\n    inlineScript = require('./inlineScript'),\n    inlineCss = require('./inlineCss'),\n    cssSupport = require('./cssSupport');\n\n\nvar getUrlBasePath = function (url) {\n    return util.joinUrl(url, '.');\n};\n\nvar parameterHashFunction = function (params) {\n    // HACK JSON.stringify is poor man's hashing;\n    // same objects might not receive same result as key order is not guaranteed\n    var a = params.map(function (param, idx) {\n        // Only include options relevant for method\n        if (idx === (params.length - 1)) {\n            param = {\n                // Two different HTML pages on the same path level have the same base path, but a different URL\n                baseUrl: getUrlBasePath(param.baseUrl)\n            };\n        }\n        return JSON.stringify(param);\n    });\n    return a;\n};\n\nvar memoizeFunctionOnCaching = function (func, options) {\n    if ((options.cache !== false && options.cache !== 'none') && options.cacheBucket) {\n        return util.memoize(func, parameterHashFunction, options.cacheBucket);\n    } else {\n        return func;\n    }\n};\n\n/* Style inlining */\n\nvar requestExternalsForStylesheet = function (styleContent, alreadyLoadedCssUrls, options) {\n    var cssRules = cssSupport.rulesForCssText(styleContent);\n\n    return inlineCss.loadCSSImportsForRules(cssRules, alreadyLoadedCssUrls, options).then(function (cssImportResult) {\n        return inlineCss.loadAndInlineCSSResourcesForRules(cssRules, options).then(function (cssResourcesResult) {\n            var errors = cssImportResult.errors.concat(cssResourcesResult.errors),\n                hasChanges = cssImportResult.hasChanges || cssResourcesResult.hasChanges;\n\n            if (hasChanges) {\n                styleContent = cssSupport.cssRulesToText(cssRules);\n            }\n\n            return {\n                hasChanges: hasChanges,\n                content: styleContent,\n                errors: errors\n            };\n        });\n    });\n};\n\nvar loadAndInlineCssForStyle = function (style, options, alreadyLoadedCssUrls) {\n    var styleContent = style.textContent,\n        processExternals = memoizeFunctionOnCaching(requestExternalsForStylesheet, options);\n\n    return processExternals(styleContent, alreadyLoadedCssUrls, options).then(function (result) {\n        if (result.hasChanges) {\n            style.childNodes[0].nodeValue = result.content;\n        }\n\n        return util.cloneArray(result.errors);\n    });\n};\n\nvar getCssStyleElements = function (doc) {\n    var styles = doc.getElementsByTagName(\"style\");\n\n    return Array.prototype.filter.call(styles, function (style) {\n        return !style.attributes.type || style.attributes.type.value === \"text/css\";\n    });\n};\n\nexports.loadAndInlineStyles = function (doc, options) {\n    var styles = getCssStyleElements(doc),\n        allErrors = [],\n        alreadyLoadedCssUrls = [],\n        inlineOptions;\n\n    inlineOptions = util.clone(options);\n    inlineOptions.baseUrl = inlineOptions.baseUrl || util.getDocumentBaseUrl(doc);\n\n    return Promise.all(styles.map(function (style) {\n        return loadAndInlineCssForStyle(style, inlineOptions, alreadyLoadedCssUrls).then(function (errors) {\n            allErrors = allErrors.concat(errors);\n        });\n    })).then(function () {\n        return allErrors;\n    });\n};\n\n/* CSS link inlining */\n\nvar substituteLinkWithInlineStyle = function (oldLinkNode, styleContent) {\n    var parent = oldLinkNode.parentNode,\n        styleNode;\n\n    styleContent = styleContent.trim();\n    if (styleContent) {\n        styleNode = oldLinkNode.ownerDocument.createElement(\"style\");\n        styleNode.type = \"text/css\";\n        styleNode.appendChild(oldLinkNode.ownerDocument.createTextNode(styleContent));\n\n        parent.insertBefore(styleNode, oldLinkNode);\n    }\n\n    parent.removeChild(oldLinkNode);\n};\n\nvar requestStylesheetAndInlineResources = function (url, options) {\n    return util.ajax(url, options)\n        .then(function (content) {\n            var cssRules = cssSupport.rulesForCssText(content);\n\n            return {\n                content: content,\n                cssRules: cssRules\n            };\n        })\n        .then(function (result) {\n            var hasChangesFromPathAdjustment = inlineCss.adjustPathsOfCssResources(url, result.cssRules);\n\n            return {\n                content: result.content,\n                cssRules: result.cssRules,\n                hasChanges: hasChangesFromPathAdjustment\n            };\n        })\n        .then(function (result) {\n            return inlineCss.loadCSSImportsForRules(result.cssRules, [], options)\n                .then(function (cssImportResult) {\n                    return {\n                        content: result.content,\n                        cssRules: result.cssRules,\n                        hasChanges: result.hasChanges || cssImportResult.hasChanges,\n                        errors: cssImportResult.errors\n                    };\n                });\n        })\n        .then(function (result) {\n            return inlineCss.loadAndInlineCSSResourcesForRules(result.cssRules, options)\n                .then(function (cssResourcesResult) {\n                    return {\n                        content: result.content,\n                        cssRules: result.cssRules,\n                        hasChanges: result.hasChanges || cssResourcesResult.hasChanges,\n                        errors: result.errors.concat(cssResourcesResult.errors)\n                    };\n                });\n        })\n        .then(function (result) {\n            var content = result.content;\n            if (result.hasChanges) {\n                content = cssSupport.cssRulesToText(result.cssRules);\n            }\n            return {\n                content: content,\n                errors: result.errors\n            };\n        });\n};\n\nvar loadLinkedCSS = function (link, options) {\n    var cssHref = link.attributes.href.value,\n        documentBaseUrl = util.getDocumentBaseUrl(link.ownerDocument),\n        ajaxOptions = util.clone(options);\n\n    if (!ajaxOptions.baseUrl && documentBaseUrl) {\n        ajaxOptions.baseUrl = documentBaseUrl;\n    }\n\n    var processStylesheet = memoizeFunctionOnCaching(requestStylesheetAndInlineResources, options);\n\n    return processStylesheet(cssHref, ajaxOptions).then(function (result) {\n        return {\n            content: result.content,\n            errors: util.cloneArray(result.errors)\n        };\n    });\n};\n\nvar getCssStylesheetLinks = function (doc) {\n    var links = doc.getElementsByTagName(\"link\");\n\n    return Array.prototype.filter.call(links, function (link) {\n        return link.attributes.rel && link.attributes.rel.value === \"stylesheet\" &&\n            (!link.attributes.type || link.attributes.type.value === \"text/css\");\n    });\n};\n\nexports.loadAndInlineCssLinks = function (doc, options) {\n    var links = getCssStylesheetLinks(doc),\n        errors = [];\n\n    return Promise.all(links.map(function (link) {\n        return loadLinkedCSS(link, options).then(function(result) {\n            substituteLinkWithInlineStyle(link, result.content + \"\\n\");\n\n            errors = errors.concat(result.errors);\n        }, function (e) {\n            errors.push({\n                resourceType: \"stylesheet\",\n                url: e.url,\n                msg: \"Unable to load stylesheet \" + e.url\n            });\n        });\n    })).then(function () {\n        return errors;\n    });\n};\n\n/* Main */\n\nexports.loadAndInlineImages = inlineImage.inline;\nexports.loadAndInlineScript = inlineScript.inline;\n\nexports.inlineReferences = function (doc, options) {\n    var allErrors = [],\n        inlineFuncs = [\n            exports.loadAndInlineImages,\n            exports.loadAndInlineStyles,\n            exports.loadAndInlineCssLinks];\n\n    if (options.inlineScripts !== false) {\n        inlineFuncs.push(exports.loadAndInlineScript);\n    }\n\n    return Promise.all(inlineFuncs.map(function (func) {\n        return func(doc, options)\n            .then(function (errors) {\n                allErrors = allErrors.concat(errors);\n            });\n    })).then(function () {\n        return allErrors;\n    });\n};\n"]},"metadata":{},"sourceType":"script"}